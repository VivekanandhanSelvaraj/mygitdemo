/* 03-NOV-2025	Vivekanandhan Selvaraj	DX_DMND0002326	Ramp web services integratiing with PeopleSoft */

/* Start	03-NOV-2025	Vivekanandhan Selvaraj	DX_DMND0002326	Ramp web services integratiing with PeopleSoft */

import DX_API:consumer:ramp:*;

class expense extends DX_API:consumer:ramp:authorization
   method expense();
   method RampExpenseGet() Returns string;
end-class;

method expense
   Local string &strToken;
   %Super = create DX_API:consumer:ramp:authorization();
   &strToken = %Super.propstr_GeneratedAccessToken;
   MessageBox(0, "", 0, 0, "Token in User Constructor " | %Super.propstr_GeneratedAccessToken);
end-method;

method RampExpenseGet
   /+ Returns String +/
   
   Local string &id;
   Local string &jsonResponseString;
   Local integer &nbPostCount;
   Local SQL &sqlPostDataSelect;
   Local Record &recRampUser;
   
   Local Document &docUriDocument;
   Local Compound &comUriCompound;
   
   Local JsonParser &js_parser;
   Local JsonObject &js_rootObj;
   Local JsonArray &js_DataArray;
   Local JsonObject &js_DataObj;
   Local JsonObject &pageObj;
   
   Local JsonArray &js_CustomFieldsArray;
   Local JsonObject &js_CustomFieldsObj;
   Local number &j;
   Local string &strCustomName;
   Local string &strCustomValue;
   
   Local integer &ui;
   Local string &tokenType, &accessToken;
   Local string &nextUrl;
   
   Local string &strRequestString;
   Local string &strRamp_TempUserID;
   Local string &strRamp_emplid;
   Local number &numRamp_empl_rcd;
   Local string &strRamp_hr_status;
   Local string &strRamp_empl_status;
   Local string &strRamp_elig_config5;
   Local string &strRamp_emailid;
   Local string &strRamp_first_name;
   Local string &strRamp_last_name;
   Local boolean &bRamp_Ismanager;
   Local string &strRamp_Ismanager;
   Local string &strRamp_location;
   Local string &strRamp_manager_id;
   Local string &strRamp_phone;
   Local string &strRamp_deptid;
   Local string &strRamp_chartfield1;
   Local string &strRamp_chartfield2;
   Local string &strRamp_chartfield3;
   Local string &strRamp_product;
   Local string &strRamp_operating_unit;
   Local string &strRamp_company;
   Local datetime &datetimeRamp_last_update_dttm;
   Local date &dateRamp_termination_dt;
   Local date &dateRamp_asgn_end_dt;
   Local string &strRamp_text254;
   Local string &strRamp_status;
   Local string &strRamp_role;
   Local string &strRamp_entity_id;
   Local string &strRamp_business_id;
   
   Local boolean &bIsJsonArr;
   Local boolean &bIsJsonArr_CustomFields;
   Local boolean &bValidateUserGetKey;
   Local number &i;
   
   &jsonResponseString = %Super.SendMessage("DX_RAMP_USER_GET", "", 1, "", "");
   
   /* Create parser object */
   &js_parser = CreateJsonParser();
   
   /* Parse JSON string */
   If &js_parser.Parse(&jsonResponseString) Then
      /* Get root JSON object */
      &js_rootObj = &js_parser.GetRootObject();
      &bIsJsonArr = &js_rootObj.IsJsonArray("data");
      MessageBox(0, "", 0, 0, "Is Resources array present - " | &bIsJsonArr | " - " | &js_rootObj.GetJsonArray("data").Length());
      If &bIsJsonArr Then
         &js_DataArray = &js_rootObj.GetJsonArray("data");
         
         /* Loop through the array elements */
         For &i = 1 To &js_DataArray.Length()
            /* Get each JSON object in the array */
            &js_DataObj = &js_DataArray.GetJsonObject(&i);
            
            /* Extract data from the object */
            If &js_DataObj.IsNullProperty("department_id") Then
               &strRamp_deptid = "";
            Else
               &strRamp_deptid = &js_DataObj.GetString("department_id");
            End-If;
            If &js_DataObj.IsNullProperty("last_name") Then
               &strRamp_last_name = "";
            Else
               &strRamp_last_name = &js_DataObj.GetString("last_name");
            End-If;
            If &js_DataObj.IsNullProperty("location_id") Then
               &strRamp_location = "";
            Else
               &strRamp_location = &js_DataObj.GetString("location_id");
            End-If;
            
            &bIsJsonArr_CustomFields = &js_DataObj.IsJsonArray("custom_fields");
            If &bIsJsonArr_CustomFields Then
               &js_CustomFieldsArray = &js_DataObj.GetJsonArray("custom_fields");
               If &js_CustomFieldsArray.Length() > 0 Then
                  /* Loop through the array elements if there is data*/
                  For &j = 1 To &js_CustomFieldsArray.Length()
                     &js_CustomFieldsObj = &js_CustomFieldsArray.GetJsonObject(&j);
                     If &js_CustomFieldsObj.IsNullProperty("name") Then
                        &strCustomName = "";
                     Else
                        &strCustomName = &js_CustomFieldsObj.GetString("name");
                     End-If;
                     If &js_CustomFieldsObj.IsNullProperty("value") Then
                        &strCustomValue = "";
                     Else
                        &strCustomValue = &js_CustomFieldsObj.GetString("value");
                     End-If;
                  End-For;
               End-If;
            End-If;
            If &js_DataObj.IsNullProperty("phone") Then
               &strRamp_phone = "";
            Else
               &strRamp_phone = &js_DataObj.GetString("phone");
            End-If;
            If &js_DataObj.IsNullProperty("role") Then
               &strRamp_role = "";
            Else
               &strRamp_role = &js_DataObj.GetString("role");
            End-If;
            If &js_DataObj.IsNullProperty("email") Then
               &strRamp_emailid = "";
            Else
               &strRamp_emailid = &js_DataObj.GetString("email");
            End-If;
            If &js_DataObj.IsNullProperty("id") Then
               &id = "";
            Else
               &id = &js_DataObj.GetString("id");
            End-If;
            If &js_DataObj.IsNullProperty("entity_id") Then
               &strRamp_entity_id = "";
            Else
               &strRamp_entity_id = &js_DataObj.GetString("entity_id");
            End-If;
            If &js_DataObj.IsNullProperty("business_id") Then
               &strRamp_business_id = "";
            Else
               &strRamp_business_id = &js_DataObj.GetString("business_id");
            End-If;
            If &js_DataObj.IsNullProperty("status") Then
               &strRamp_status = "";
            Else
               &strRamp_status = &js_DataObj.GetString("status");
            End-If;
            If &js_DataObj.IsNullProperty("employee_id") Then
               &strRamp_emplid = "";
            Else
               &strRamp_emplid = &js_DataObj.GetString("employee_id");
            End-If;
            If &js_DataObj.IsNullProperty("first_name") Then
               &strRamp_first_name = "";
            Else
               &strRamp_first_name = &js_DataObj.GetString("first_name");
            End-If;
            If &js_DataObj.IsNullProperty("is_manager") Then
               &bRamp_Ismanager = False;
            Else
               &bRamp_Ismanager = &js_DataObj.GetBoolean("is_manager");
            End-If;
            If &bRamp_Ismanager Then
               &strRamp_Ismanager = "Y"
            Else
               &strRamp_Ismanager = "N"
            End-If;
            
            If &js_DataObj.IsNullProperty("manager_id") Then
               &strRamp_manager_id = "";
            Else
               &strRamp_manager_id = &js_DataObj.GetString("manager_id");
            End-If;
            
            
            REM MessageBox(0, "", 0, 0, "New User &id : " | &id);
            &recRampUser = CreateRecord(Record.DX_RAMP_USER);
            &recRampUser.DX_RAMP_UUID.Value = &id;
            &bValidateUserGetKey = &recRampUser.SelectByKey();
            
            &recRampUser.DX_RAMP_UUID.Value = &id;
            &recRampUser.EMPLOYEE_ID.Value = &strRamp_emplid;
            &recRampUser.DX_RAMP_LOC_ID.Value = &strRamp_location;
            &recRampUser.DX_RAMP_ENT_ID.Value = &strRamp_company;
            &recRampUser.EMAILID.Value = &strRamp_emailid;
            
            &recRampUser.DX_RAMP_MGR_ID.Value = &strRamp_manager_id;
            &recRampUser.DX_RAMP_DEP_ID.Value = &strRamp_deptid;
            &recRampUser.DX_RAMP_BUS_ID.Value = &strRamp_business_id;
            &recRampUser.FIRST_NAME.Value = &strRamp_first_name;
            &recRampUser.LAST_NAME.Value = &strRamp_last_name;
            &recRampUser.PHONE.Value = &strRamp_phone;
            &recRampUser.ROLENAME.Value = &strRamp_role;
            &recRampUser.STATUSIMG.Value = &strRamp_status;
            &recRampUser.MANAGER.Value = &strRamp_Ismanager;
            &recRampUser.LASTUPDOPRID.Value = %OperatorId;
            &recRampUser.LASTUPDDTTM.Value = %Datetime;
            If &bValidateUserGetKey Then
               &recRampUser.Update();
               MessageBox(0, "", 0, 0, "Update - " | &id);
            Else
               &recRampUser.Insert();
               MessageBox(0, "", 0, 0, "Insert - " | &id);
            End-If;
         End-For;
      Else
      End-If;
      
      
      /* Use the extracted values - here just a message box */
      rem MessageBox(0, "", 0, 0, "ID: " | &id | Char(13) | "Name: " | &name);
   Else
   End-If;
   
   Return %Super.propstr_GeneratedAccessToken;
end-method;

